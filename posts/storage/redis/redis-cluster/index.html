<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Redis 集群部署 - xdhuxc</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="xdhuxc" /><meta name="description" content="本篇博客主要介绍了 Redis 的集群部署。
" />






<meta name="generator" content="Hugo 0.68.3 with theme even" />


<link rel="canonical" href="https://xdhuxc.github.io/posts/storage/redis/redis-cluster/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">



<meta property="og:title" content="Redis 集群部署" />
<meta property="og:description" content="本篇博客主要介绍了 Redis 的集群部署。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xdhuxc.github.io/posts/storage/redis/redis-cluster/" />
<meta property="article:published_time" content="2018-08-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-09-27T00:00:00+00:00" />
<meta itemprop="name" content="Redis 集群部署">
<meta itemprop="description" content="本篇博客主要介绍了 Redis 的集群部署。">
<meta itemprop="datePublished" content="2018-08-04T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-09-27T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2227">



<meta itemprop="keywords" content="Redis,数据库," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 集群部署"/>
<meta name="twitter:description" content="本篇博客主要介绍了 Redis 的集群部署。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">xdhuxc</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/posts/">
        <li class="mobile-menu-item">文章</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a><a href="">
        <li class="mobile-menu-item"></li>
      </a><a href="">
        <li class="mobile-menu-item"></li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">xdhuxc</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/posts/">文章</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href=""></a>
      </li><li class="menu-item">
        <a class="menu-item-link" href=""></a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
  <div class="post-content">
    <p>本篇博客主要介绍了 Redis 的集群部署。</p>
<h3 id="redis-集群的搭建一">Redis 集群的搭建（一）</h3>
<blockquote>
<p>在一台 CentOS 7 虚拟机中搭建三个节点的 Redis 集群，该节点IP地址为：192.168.244.129</p>
</blockquote>
<p>1、根据 <code>在 Linux 中安装 Redis</code> 安装 Redis 并成功启动单个实例</p>
<p>2、在 <code>/home/application/redis-4.0.1</code> 目录下创建 redis-cluster 目录，在该目录下分别创建 redis-1、redis-2、redis-3目录，复制redis.conf到redis-1、redis-2、redis-3目录下并分别创建log目录</p>
<p>3、修改redis-1、redis-2、redis-3目录下的redis.conf，修改内容如下所示：</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>redis_1</th>
<th>redis_2</th>
<th>redis_3</th>
</tr>
</thead>
<tbody>
<tr>
<td>IP</td>
<td>192.168.244.129</td>
<td>192.168.244.129</td>
<td>192.168.244.129</td>
</tr>
<tr>
<td>端口</td>
<td>8001</td>
<td>8002</td>
<td>8003</td>
</tr>
<tr>
<td>daemonize</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>pidfile</td>
<td>/var/run/redis_8001.pid</td>
<td>/var/run/redis_8002.pid</td>
<td>/var/run/redis_8003.pid</td>
</tr>
<tr>
<td>cluster-enabled</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>cluster-config-file</td>
<td>./config/nodes_8001.conf</td>
<td>./config/nodes_8002.conf</td>
<td>./config/nodes_8003.conf</td>
</tr>
<tr>
<td>cluster-node-timeout</td>
<td>15000</td>
<td>15000</td>
<td>15000</td>
</tr>
<tr>
<td>appendonly</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>logfile</td>
<td>/home/application/redis-4.0.1/redis_cluster/redis_1/log/</td>
<td>/home/application/redis-4.0.1/redis_cluster/redis_2/log/</td>
<td>/home/application/redis-4.0.1/redis_cluster/redis_3/log/</td>
</tr>
</tbody>
</table>
<p>4、将 redis-trib.rb 复制到 /usr/local/bin 目录下，使用 redis-trib.rb 工具启动集群。
报如下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost src]# redis-trib.rb create --replicas 1 192.168.244.129:8001 192.168.244.129:8002 192.168.244.129:8003 192.168.244.133:8004 192.168.244.133:8005 192.168.244.133:8006
/usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in <span class="sb">`require&#39;: cannot load such file -- redis (LoadError)
</span><span class="sb">	from /usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in `</span>require&#39;
	from /usr/local/bin/redis-trib.rb:25:in `&lt;main&gt;&#39;
</code></pre></td></tr></table>
</div>
</div><p>解决：</p>
<p>使用 gem 安装 Redis，使用如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost src]# gem install redis
</code></pre></td></tr></table>
</div>
</div><p>报错如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost src]# gem install redis
ERROR:  Could not find a valid gem &#39;redis&#39; (&gt;= 0), here is why:
          Unable to download data from https://rubygems.org/ - Errno::ECONNREFUSED: Connection refused - connect(2) (https://rubygems.org/latest_specs.4.8.gz)
</code></pre></td></tr></table>
</div>
</div><p>报错如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost application]# gem install redis
ERROR:  Error installing redis:
	redis requires Ruby version &gt;= 2.2.2.
</code></pre></td></tr></table>
</div>
</div><p>显示ruby版本须高于2.2.2，查看yum安装的ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">ruby -version
</code></pre></td></tr></table>
</div>
</div><h3 id="安装指定版本的-ruby">安装指定版本的 ruby</h3>
<p>1）安装 curl，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">sudo yum install curl
</code></pre></td></tr></table>
</div>
</div><p>2）安装RVM，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">curl -L get.rvm.io | bash -s table
</code></pre></td></tr></table>
</div>
</div><p>3）执行下面命令</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">source /usr/local/rvm/scripts/rvm
</code></pre></td></tr></table>
</div>
</div><p>4）查看rvm库中已知的ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">rvm list known
</code></pre></td></tr></table>
</div>
</div><p>5）安装一个ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">rvm install 2.3.3
</code></pre></td></tr></table>
</div>
</div><p>6）使用一个ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">rvm use 2.3.3
</code></pre></td></tr></table>
</div>
</div><p>7）卸载指定版本的ruby</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">rvm remove 2.0.0
</code></pre></td></tr></table>
</div>
</div><p>8）查看ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">ruby --version
</code></pre></td></tr></table>
</div>
</div><p>安装完成后，查看安装的ruby版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost ~]# ruby -version
ruby 2.4.1p111 (2017-03-22 revision 58053) [x86_64-linux]
-e:1:in <span class="sb">`&lt;main&gt;&#39;: undefined local variable or method `</span>rsion&#39; for main:Object (NameError)
</code></pre></td></tr></table>
</div>
</div><p>5、使用gem安装redis</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">gem install redis
</code></pre></td></tr></table>
</div>
</div><p>6、在 <code>192.168.244.129</code> 上启动三个 Redis 实例，搭建伪分布式集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost redis-4.0.1]# redis-trib.rb create --replicas 0 192.168.244.129:8001 192.168.244.129:8002 192.168.244.129:8003 
&gt;&gt;&gt; Creating cluster
&gt;&gt;&gt; Performing hash slots allocation on 3 nodes...
Using 3 masters:
192.168.244.129:8001
192.168.244.129:8002
192.168.244.129:8003
M: f55b5ad14335b51c58922d60ba55990cf303fd54 192.168.244.129:8001
   slots:0-5460 (5461 slots) master
M: 6ea0f62a8dcae5fa94ae778aff06764c4dbe0674 192.168.244.129:8002
   slots:5461-10922 (5462 slots) master
M: af341ce9fda618a5905c3a7d542f649abba5c8a5 192.168.244.129:8003
   slots:10923-16383 (5461 slots) master
Can I set the above configuration? (type &#39;yes&#39; to accept): yes
&gt;&gt;&gt; Nodes configuration updated
&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join..
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.244.129:8001)
M: f55b5ad14335b51c58922d60ba55990cf303fd54 192.168.244.129:8001
   slots:0-5460 (5461 slots) master
   0 additional replica(s)
M: af341ce9fda618a5905c3a7d542f649abba5c8a5 192.168.244.129:8003
   slots:10923-16383 (5461 slots) master
   0 additional replica(s)
M: 6ea0f62a8dcae5fa94ae778aff06764c4dbe0674 192.168.244.129:8002
   slots:5461-10922 (5462 slots) master
   0 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[OK] All 16384 slots covered.
</code></pre></td></tr></table>
</div>
</div><p>已经搭建成功Redis集群。</p>
<h3 id="搭建-redis-集群二">搭建 Redis 集群（二）</h3>
<blockquote>
<p>在两台CentOS 7 虚拟机上搭建六个节点的Redis集群，IP地址分别为：192.168.244.129和192.168.244.133</p>
</blockquote>
<p>1、下载Redis安装包，使用如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">wget http://download.redis.io/releases/redis-4.0.1.tar.gz
</code></pre></td></tr></table>
</div>
</div><p>2、解压redis-4.0.1.tar.gz文件，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">tar -zxf redis-4.0.1.tar.gz
</code></pre></td></tr></table>
</div>
</div><p>3、进入redis-4.0.1目录下，编译Redis源程序，使用如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">make 
</code></pre></td></tr></table>
</div>
</div><p>编译完成后，使用如下命令测试：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">make test
</code></pre></td></tr></table>
</div>
</div><p>如果出现如下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">!!! WARNING The following tests failed:
*** [err]: Slave should be able to synchronize with the master in tests/integration/replication-psync.tcl

Replication not started.

Cleanup: may take some time... OK
</code></pre></td></tr></table>
</div>
</div><p>虚拟机中安装的时候，机器性能不够的话，很容易出现上述错误。换机器或者更换参数，以及在机器不忙的时候进行编译安装，会顺利通过。</p>
<p>4、将 src 目录下的 redis-trib.rb 复制到 /usr/local/bin 目录下，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">cp -f src/redis-trib.rb /usr/local/bin
</code></pre></td></tr></table>
</div>
</div><p>5、在 redis-4.0.1 目录下创建 redis_cluster、data 和 config 目录，在 redis_cluster 目录下创建redis_4，redis_5，redis_6目录，复制redis.conf文件至各目录下，并在各目录下创建log目录。</p>
<p>6、修改各目录下的redis.conf文件</p>
<table>
<thead>
<tr>
<th>节点</th>
<th>redis_1</th>
<th>redis_2</th>
<th>redis_3</th>
<th>redis_4</th>
<th>redis_5</th>
<th>redis_6</th>
</tr>
</thead>
<tbody>
<tr>
<td>IP</td>
<td>192.168.244.129</td>
<td>192.168.244.129</td>
<td>192.168.244.129</td>
<td>192.168.244.133</td>
<td>192.168.244.133</td>
<td>192.168.244.133</td>
</tr>
<tr>
<td>端口</td>
<td>8001</td>
<td>8002</td>
<td>8003</td>
<td>8004</td>
<td>8005</td>
<td>8006</td>
</tr>
<tr>
<td>daemonize</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>pidfile</td>
<td>/var/run/redis_8001.pid</td>
<td>/var/run/redis_8002.pid</td>
<td>/var/run/redis_8003.pid</td>
<td>/var/run/redis_8004.pid</td>
<td>/var/run/redis_8005.pid</td>
<td>/var/run/redis800_6.pid</td>
</tr>
<tr>
<td>cluster-enabled</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>cluster-config-file</td>
<td>./config/nodes_8001.conf</td>
<td>./config/nodes_8002.conf</td>
<td>./config/nodes_8003.conf</td>
<td>./config/nodes_8004.conf</td>
<td>./config/nodes_8005.conf</td>
<td>./config/nodes_8006.conf</td>
</tr>
<tr>
<td>cluster-node-timeout</td>
<td>15000</td>
<td>15000</td>
<td>15000</td>
<td>15000</td>
<td>15000</td>
<td>15000</td>
</tr>
<tr>
<td>appendonly</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
<td>yes</td>
</tr>
<tr>
<td>logfile</td>
<td>./redis_cluster/redis_1/log/</td>
<td>./redis_cluster/redis_2/log/</td>
<td>./redis_cluster/redis_3/log/</td>
<td>./redis_cluster/redis_4/log/</td>
<td>./redis_cluster/redis_5/log/</td>
<td>./redis_cluster/redis_6/log/</td>
</tr>
</tbody>
</table>
<p>将 <code>dump.rdb</code> 和 <code>appendonly.aof</code> 文件的目录修改至 <code>./data</code> 目录下</p>
<p>7、在 <code>192.168.244.129</code> 和 <code>192.168.244.133</code> 上各启动三个Redis实例，搭建含有六个节点的跨主机集群，在 <code>192.168.244.129</code> 上执行如下命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">redis-trib.rb create --replicas 1 192.168.244.129:8001 192.168.244.129:8002 192.168.244.129:8003 192.168.244.133:8004 192.168.244.133:8005 192.168.244.133:8006
</code></pre></td></tr></table>
</div>
</div><p>执行后，报如下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">&gt;&gt;&gt; Creating cluster
[ERR] Sorry, can&#39;t connect to node 192.168.244.133:8004
</code></pre></td></tr></table>
</div>
</div><p>可能是因为192.168.244.133上的相应端口未开放
解决：</p>
<blockquote>
<p>CentOS 7 使用firewalld代替了iptables
在 <code>192.168.244.133</code> 上开启防火墙端口8004、8005、8006，使用命令为：</p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">firewall-cmd --zone=public --add-port=8004/tcp --permanent # --zone <span class="ni">#作用域</span> --add-port=80/tcp  <span class="ni">#添加端口</span>，格式为：端口/通讯协议 --permanent  <span class="ni">#永久生效</span>，没有此参数重启后失效
firewall-cmd --reload # 重启防火墙
</code></pre></td></tr></table>
</div>
</div><p>之后重新启动集群，出现如下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost redis-4.0.1]# redis-trib.rb create --replicas 1 192.168.244.129:8001 192.168.244.129:8002 192.168.244.129:8003 192.168.244.133:8004 192.168.244.133:8005 192.168.244.133:8006
&gt;&gt;&gt; Creating cluster
[ERR] Node 192.168.244.129:8001 is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0.
</code></pre></td></tr></table>
</div>
</div><p>解决：
清理掉 <code>redis-4.0.1</code> 目录下的 appendonly.aof dump.rdb nodes-*.conf 文件，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">rm -f appendonly.aof dump.rdb nodes-*.conf
</code></pre></td></tr></table>
</div>
</div><p>重新启动六个Redis实例，出现如下错误：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">&gt;&gt;&gt; Assign a different config epoch to each node
&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster
Waiting for the cluster to join.............................................................................................................................................................................
</code></pre></td></tr></table>
</div>
</div><p>原因：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">Every Redis Cluster node requires two TCP connections open. The
normal Redis TCP port used to serve clients, for example 6379, plus
the port obtained by adding 10000 to the data port, so 16379 in the
example. This second high port is used for the Cluster bus, that is
a node-to-node communication channel using a binary protocol. The
Cluster bus is used by nodes for failure detection, configuration
update, failover authorization and so forth. Clients should never
try to communicate with the cluster bus port, but always with the
normal Redis command port, however make sure you open both ports in
your firewall, otherwise Redis cluster nodes will be not able to
communicate. The command port and cluster bus port offset is fixed
and is always 10000. Note that for a Redis Cluster to work properly
you need, for each node: The normal client communication port
(usually 6379) used to communicate with clients to be open to all
the clients that need to reach the cluster, plus all the other
cluster nodes (that use the client port for keys migrations). The
cluster bus port (the client port + 10000) must be reachable from
all the other cluster nodes. If you don&#39;t open both TCP ports, your
cluster will not work as expected. The cluster bus uses a
different, binary protocol, for node to node data exchange, which
is more suited to exchange information between nodes using little
bandwidth and processing time. i use AWS, due to don&#39;t open 16379
16380 port, cause this issue
</code></pre></td></tr></table>
</div>
</div><p>解决：
在 <code>192.168.244.133</code> 上开放 <code>18004</code>、<code>18005</code> 和 <code>18006</code> 端口以供 <code>redis</code> 集群数据通讯。</p>
<p>在搭建过程中，可以使用redis-trib.rb测试各个节点的连接情况：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost redis-3.2.10]# redis-trib.rb check 192.168.244.133:8007
&gt;&gt;&gt; Performing Cluster Check (using node 192.168.244.133:8007)
M: 2c6977dce48d9abd038d066c37c91306ffd32ca2 192.168.244.133:8007
   slots: (0 slots) master
   0 additional replica(s)
[OK] All nodes agree about slots configuration.
&gt;&gt;&gt; Check for open slots...
&gt;&gt;&gt; Check slots coverage...
[ERR] Not all 16384 slots are covered by nodes.
</code></pre></td></tr></table>
</div>
</div><p>8、登录redis集群节点机，使用命令为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost redis-4.0.1]# redis-cli -h 192.168.244.129 -p 8003 
</code></pre></td></tr></table>
</div>
</div><p>若要停止Redis服务，可以使用命令：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">[root@localhost redis-4.0.1]# redis-cli -h 192.168.244.129 -p 8003 shutdown
</code></pre></td></tr></table>
</div>
</div>
  </div>
</article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
  <a href="" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    %!(EXTRA string=<a class="hexo-link" href="https://gohugo.io">Hugo</a>)
  </span>
  <span class="division">|</span>
  <span class="theme-info">
     - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
     - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">xdhuxc 版权所有</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
