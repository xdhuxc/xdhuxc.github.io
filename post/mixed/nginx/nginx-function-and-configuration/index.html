<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>nginx 常用功能及配置详解 - xdhuxc</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="xdhuxc" /><meta name="description" content="本篇博客介绍了 nginx 的常用功能和其配置的详细含义。
" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.61.0 with theme even" />


<link rel="canonical" href="https://xdhuxc.github.io/post/mixed/nginx/nginx-function-and-configuration/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="nginx 常用功能及配置详解" />
<meta property="og:description" content="本篇博客介绍了 nginx 的常用功能和其配置的详细含义。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xdhuxc.github.io/post/mixed/nginx/nginx-function-and-configuration/" />
<meta property="article:published_time" content="2018-04-26T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-10-29T00:00:00+00:00" />
<meta itemprop="name" content="nginx 常用功能及配置详解">
<meta itemprop="description" content="本篇博客介绍了 nginx 的常用功能和其配置的详细含义。">
<meta itemprop="datePublished" content="2018-04-26T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-10-29T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="5653">



<meta itemprop="keywords" content="Nginx," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="nginx 常用功能及配置详解"/>
<meta name="twitter:description" content="本篇博客介绍了 nginx 的常用功能和其配置的详细含义。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Xdhuxc</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">主页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">博客</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">目录</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Xdhuxc</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">主页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">博客</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">目录</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">nginx 常用功能及配置详解</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-04-26 </span>
        <div class="post-category">
            <a href="/categories/%E6%8A%80%E6%9C%AF/"> 技术 </a>
            </div>
          <span class="more-meta"> 约 5653 字 </span>
          <span class="more-meta"> 预计阅读 12 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#nginx-">nginx 简介</a></li>
        <li><a href="#nginx--1">nginx 常用功能</a></li>
        <li><a href="#nginx--2">nginx 配置文件</a></li>
        <li><a href="#heading">负载均衡和反向代理配置</a></li>
        <li><a href="#nginx--location-">nginx 中 location 的写法</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>本篇博客介绍了 nginx 的常用功能和其配置的详细含义。</p>
<h3 id="nginx-">nginx 简介</h3>
<p>nginx 是一个轻量级高性能的 web 服务器，它是为快速响应大量静态文件请求和高效利用系统资源而设计的。与apache使用面向进程或线程的方式处理请求不同，nginx使用异步事件驱动模型在负载下性能更突出。</p>
<p>nginx 功能丰富，可作为 HTTP 服务器，也可作为反向代理服务器和邮件服务器，支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能，并且支持很多第三方的模块扩展。</p>
<p>虽然nginx能高效地服务静态文件，但也有人认为nginx处理动态内容并不理想。不像apache服务器，nginx没用使用内嵌解释器的方式来处理动态内容。相反，动态内容被丢给cgi，fastcgi或者像apache这样的web服务器，然后把处理结果返回给nginx，nginx在返给浏览器。这种方式就导致部署起来会更复杂一些。出于这些原因，使用和配置nginx可能会晦涩。nginx的配置感觉更复杂或者不直接。</p>
<h3 id="nginx--1">nginx 常用功能</h3>
<p>1、HTTP 代理，反向代理</p>
<p>作为 Web 服务器最常用的功能之一，尤其是反向代理。nginx 在做反向代理时，提供性能稳定、配置灵活的转发功能。 nginx 可以根据不同的正则匹配，采取不同的转发策略，比如图片文件的转发至文件服务器、动态页面的转发至web服务器。并且， nginx 对返回结果进行错误页跳转、异常判断等。如果被分发的服务器存在异常，可以将请求重新转发给另外一台服务器，然后自动去除异常服务器。</p>
<p>2、负载均衡</p>
<p>nginx 提供的负载均衡策略有两种：内置策略和扩展策略。内置策略包括：轮询，加权轮询，IP hash。扩展策略非常多，几乎涵盖所有的负载均衡算法。</p>
<p>IP Hash算法：对客户端请求的IP地址进行Hash操作，然后根据Hash结果将同一个客户端IP的请求分发给同一台服务器进行处理，可以解决 session 不共享的问题。</p>
<p>3、Web 缓存</p>
<p>nginx 可以对不同的文件做不同的缓存处理，配置灵活，并且支持FastCGI_Cache，主要用于对 FastCGI的动态程序进行缓存。配合第三方的ngx_cache_purge，对指定的 URL 缓存内容可以进行增删管理。</p>
<h3 id="nginx--2">nginx 配置文件</h3>
<p>nginx 的强大都是靠配置文件来实现，nginx 就是一个二进制文件 nginx 读入一个配置文件 nginx.conf (nginx.conf可能include包含若干子配置文件)来实现各种各样的功能。</p>
<h4 id="nginx--3">nginx 配置文件结构</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">...                           # 全局块
events {                      # events 块
    ...       
}
http {                        # http 块
    ...                       # http 全局块
    server {                  # server 块
        ...                   # server 全局块
        location [PATTERN] {  # location 块  
            ...
        }   
        location [PATTERN] {
            ...
        }
    }
    server {
        ...
    }
    ...                       # http 块
}

</code></pre></td></tr></table>
</div>
</div><p>1、全局块</p>
<p>配置影响 nginx 全局的指令。一般有运行 nginx 服务器的用户组， nginx 进程 pid 存放路径，日志文件存放路径，配置文件引入，允许生成的 worker process数等。</p>
<p>2、events 块</p>
<p>配置影响 nginx 服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网络连接，开启多个网络连接序列化等。</p>
<p>3、http 块</p>
<p>可以嵌套多个 server块，配置代理、缓存、日志定义等绝大多数功能和第三方模块的配置，如文件引入、mime-type定义、日志自定义、是否使用 sendfile 传输文件、连接超时时间、单连接请求数等。</p>
<p>4、server 块</p>
<p>配置虚拟主机的相关参数，一个 http 块中可以有多个 server 块。</p>
<p>5、location 块</p>
<p>配置请求的路由，以及各种页面的处理情况。</p>
<h4 id="nginx--4">nginx 配置文件示例</h4>
<p>nginx.conf文件示例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">user administrator administrator; # 配置用户或者用户组，默认为nobody nobody。
worker_processes 2;               # 允许生成的进程数，设置值和CPU核心数一致，默认为：1。在nginx1.3.8和1.2.5之后的版本开始支持auto，自动匹配进程数。
pid /var/nginx/nginx.pid # 指定 nginx 进程运行文件存放地址。
error_log /var/log/nginx/error.log debug # 指定错误日志存放路径及级别，该设置可以放入全局块、http块、server块，日志级别依次为：debug|info|notice|warn|error|crit|alert|emerg。
events {
    accept_mutex on; # 设置网络连接序列化，防止惊群现象发生，默认为：on。
    multi_accept on; # 设置一个进程是否同时接受多个网络连接，默认为：off。
    use epoll;        # 指定事件驱动模型，可以为：select|poll|kqueue|epoll|resig|/dev/poll|eventport。
    worker_connections 1024; # 设置最大连接数，默认为：512。
}
http {
    include mime.types; # 文件扩展名与文件类型映射表。
    default_type application/octet-stream; # 指定默认文件类型，默认为：text/plain。
    <span class="ni">#access_log</span> off # 取消服务日志。
    
    log_format  main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; &#39;
                      &#39;$status $body_bytes_sent &#34;$http_referer&#34; &#39;
                      &#39;&#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;  # 自定义格式
    access_log /var/log/nginx/access.log main; # combined为日志格式的默认值。
    sendfile on; # 允许sendfile方式传输文件，默认为：off，可以在http块、server块、location块中定义。
    sendfile_max_chunk 100K; # 每个进程每次调用传输数量不能大于设定的值，默认值为：0，即不设上限。
    keepalive_timeout 65;    # 连接超时时间，默认为：75s，可以在http块、server块和location块中设置。
    
    upstream xdhuxc {
        server 127.0.0.1:8080;
        server 192.168.91.128:9090 backup; # 热备，
    }
    
    error_page 404 https://www.baidu.com # 错误页。
    
    server {
        listen 8080;            # 监听端口。
        server_name 127.0.0.1;  # 监听地址。
        keepalive_requests 120; # 单连接请求上限次数。
        location ~*^.+$ {       # 请求的 url 过滤，正则匹配，~ 为区分大小写，~* 为不区分大小写。
            # root path;   # 根目录。
            # index index.html index.htm; # 设置默认页。
            proxy_pass http://xdhuxc; # 请求转向 xdhuxc 定义的服务器列表。
            deny 127.0.0.1; # 拒绝的IP。
            allow 172.18.5.54; 允许的IP。
        }
        
    }
}
</code></pre></td></tr></table>
</div>
</div><p>注意：</p>
<p>1、log_format中参数的含义</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">$remote_addr 和 $http_x_forwarded_for 用以记录客户端的IP地址。
$remote_user 用来记录客户端用户名称。
$time_local 用来记录访问时间与时区。
$request 用来记录请求的url与http协议。
$status 用来记录请求状态，成功为200。
$body_bytes_sent 记录发送给客户端文件主体内容大小。
$http_referer 用来记录从哪个页面链接访问过来的。
$http_user_agent 用来记录客户端浏览器的相关信息。
</code></pre></td></tr></table>
</div>
</div><p>2、惊群现象：一个网络连接到来，多个睡眠的进程被同时叫醒，但只有一个进程能获得连接，这样会影响系统性能。</p>
<p>3、每个指令必须有分号结尾。</p>
<h3 id="heading">负载均衡和反向代理配置</h3>
<h4 id="heading-1">代理服务配置</h4>
<p>1、在 http 块中有如下配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">error_page 404 https://www.baidu.com # 设置错误页，当代理遇到状态码为404时，把错误页面导向百度。
</code></pre></td></tr></table>
</div>
</div><p>要想让该语句起作用，必须配合着下面的配置一起使用：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_intercept_errors on; # 如果被代理服务器返回的状态码为400或者大于400，设置的error_page配置起作用，默认为：off。
</code></pre></td></tr></table>
</div>
</div><p>2、如果我们的代理只允许接受get、post请求方法的一种，可进行如下配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_method get; # 支持客户端的请求方法，post/get。 
</code></pre></td></tr></table>
</div>
</div><p>3、设置支持的http协议版本</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_http_version 1.0; # nginx 服务器提供代理服务的http协议版本1.0、1.1，默认为：1.0版本。
</code></pre></td></tr></table>
</div>
</div><p>4、如果 nginx 服务器给两台 web 服务器做代理，负载均衡算法采用轮询。那么当一台服务器 web 程序不能访问时，nginx服务器分发请求还是会给这台不能访问的 web 服务器。如果这里的响应连接时间过长，就会导致客户端的页面一直在等待，严重影响客户体验。</p>
<p>如果负载均衡中，web 服务器乙发生这样的情况，nginx 首先会去 web 服务器甲请求，但是 nginx 在配置不当的情况下会继续分发请求到 web 服务器乙，然后等待 web 服务器乙响应，直到响应时间超时，才会把请求重新分发给 web 服务器甲。这里的响应时间如果过长，用户等待的时间就会越长。</p>
<p>以下配置可以作为解决方案：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_connect_timeout 1; # nginx 服务器与被代理服务器建立连接的超时时间，默认为：60s。
proxy_read_timeout 1; # nginx 服务器向被代理服务器组发出 read 请求后，等待响应的超时时间，默认为：60s。
proxy_send_timeout 1; # nginx 服务器向被代理服务器组发出 write 请求后，等待响应的超时时间，默认为：60s。
proxy_ignore_client_abort on; # 客户端断网时，nginx 服务器是否中断对被代理服务器的请求，默认为：off。
</code></pre></td></tr></table>
</div>
</div><p>5、如果使用 upstream 指令配置了一组服务器作为被代理服务器，服务器中的访问算法遵循配置的负载均衡规则，同时可以使用该指令配置在发生哪些异常情况时，将请求顺次交由下一组服务器处理。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_next_upstream timeout; # 反向代理 upstream 中设置的服务器组，出现故障时，被代理服务器返回的状态值。
</code></pre></td></tr></table>
</div>
</div><p>可以设置为：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">error | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_404 | off 
</code></pre></td></tr></table>
</div>
</div><ul>
<li>error：建立连接或向被代理的服务器发送请求或读取响应信息时，服务器发生错误。</li>
<li>timeout：建立连接或向被代理服务器发送请求或读取响应信息时，服务器发生超时。</li>
<li>invalid_header：被代理服务器返回的响应头异常。</li>
<li>off：无法将请求分发给被代理的服务器。</li>
<li>http_404,http_500,&hellip;：被代理服务器返回的状态码为404，500，502等。</li>
</ul>
<p>6、如果想通过 http 获取客户端的真实IP地址，而不是获取代理服务器的IP地址，那么需要做如下配置：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">proxy_set_header Host $host; # 只要用户在浏览器中访问的域名绑定了VIP，VIP下面有RS，则就用$host；host 是访问的URL中的域名和端口，比如，www.taobaoc.com:80
proxy_set_header X-Real-IP $remote_addr; # 把源IP（$remote_add，建立HTTP连接header里面的信息）赋值给X-Real-IP，这样在代码中，$X-Real-IP就可以获得源IP。
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; # 在nginx 作为代理服务器时，设置的IP列表，会把经过的机器IP、代理机器IP都记录下来，用&#34;,&#34;隔开，代码中使用 <span class="sb">`echo $x-forwarded-for | awk -F, &#39;{print $1}&#39;`</span> 来作为源IP。
</code></pre></td></tr></table>
</div>
</div><p>7、nginx 代理配置的配置文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">include       mime.types;                  # 文件扩展名与文件类型映射表
default_type  application/octet-stream;    # 设置默认文件类型，默认为text/plain
<span class="gh">#access_log off;                           # 取消服务日志    
</span><span class="gh"></span>log_format main &#39; $remote_addr–$remote_user [$time_local] $request $status $body_bytes_sent $http_referer $http_user_agent $http_x_forwarded_for&#39;; <span class="ni">#自定义格式</span>
access_log log/access.log main;            # combined 为日志格式的默认值
sendfile on;                               # 允许sendfile方式传输文件，默认为off，可以在http块，server块，location块。
sendfile_max_chunk 100k;                   # 每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限。
keepalive_timeout 65;                      # 连接超时时间，默认为75s，可以在http，server，location块。
proxy_connect_timeout 1;                   # nginx服务器与被代理的服务器建立连接的超时时间，默认60秒
proxy_read_timeout 1;                      # nginx服务器想被代理服务器组发出read请求后，等待响应的超时间，默认为60秒。
proxy_send_timeout 1;                      # nginx服务器想被代理服务器组发出write请求后，等待响应的超时间，默认为60秒。
proxy_http_version 1.0 ;                   # Nginx服务器提供代理服务的http协议版本1.0，1.1，默认设置为1.0版本。
<span class="gh">#proxy_method get;                         # 支持客户端的请求方法。post/get；
</span><span class="gh"></span>proxy_ignore_client_abort on;              # 客户端断网时，nginx服务器是否终端对被代理服务器的请求。默认为off。
proxy_ignore_headers &#34;Expires&#34; &#34;Set-Cookie&#34;;  <span class="ni">#Nginx服务器不处理设置的http相应投中的头域</span>，这里空格隔开可以设置多个。
proxy_intercept_errors on;                 # 如果被代理服务器返回的状态码为400或者大于400，设置的error_page配置起作用。默认为off。
proxy_headers_hash_max_size 1024;          # 存放http报文头的哈希表容量上限，默认为512个字符。
proxy_headers_hash_bucket_size 128;        # nginx服务器申请存放http报文头的哈希表容量大小。默认为64个字符。
proxy_next_upstream timeout;               # 反向代理upstream中设置的服务器组，出现故障时，被代理服务器返回的状态值。error|timeout|invalid_header|http_500|http_502|http_503|http_504|http_404|off
<span class="gh">#proxy_ssl_session_reuse on;               # 默认为：on，如果我们在错误日志中发现“SSL3_GET_FINSHED:digest check failed”的情况时，可以将该指令设置为off。
</span></code></pre></td></tr></table>
</div>
</div><h4 id="heading-2">负载均衡配置</h4>
<p>upstream 配置是写一组被代理的服务器地址，然后配置负载均衡的算法。这里的被代理服务器地址有两种写法：</p>
<p>1）、</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080;
    server 192.168.91.129:8080;
}
server {
    ...
    location ~*^.+$ {
        proxy_pass http://xdhuxc   # 请求转向 xdhuxc 定义的服务器列表。
    }
}
</code></pre></td></tr></table>
</div>
</div><p>2）、</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server http://192.168.91.128:8080;
    server http://192.168.91.129:8080;
}
server {
    ...
    location ~*^.+$ {
        proxy_pass xdhuxc;         # 请求转向 xdhuxc 定义的服务器列表。
    }
}
</code></pre></td></tr></table>
</div>
</div><p>1、热备</p>
<p>如果有两台服务器，当一台服务器发生故障时，才启用第二台服务器给用户提供服务。服务器处理请求的顺序：AAAA（突然A挂了）BBBBBBB&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080;
    server 192.168.91.129:8080 backup; # 热备
}
</code></pre></td></tr></table>
</div>
</div><p>2、轮询</p>
<p>nginx 默认就是轮询，其权重默认都为：1。服务器处理请求的顺序为：ABABABAB&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080;
    server 192.168.91.129:8080;
}
</code></pre></td></tr></table>
</div>
</div><p>3、加权轮询</p>
<p>nginx 根据配置的权重的大小而分发给不同服务器不同数量的请求。如果不设置，则默认为：1。服务器处理请求的顺序为：ABBABBABBABBABB&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080 weight=1;
    server 192.168.91.129:8080 weight=2;
}
</code></pre></td></tr></table>
</div>
</div><p>4、ip_hash</p>
<p>nginx 会让相同的客户端IP请求相同的服务器。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080;
    server 192.168.91.129:8080;
    ip_hash;
}
</code></pre></td></tr></table>
</div>
</div><p>nginx 负载均衡配置的几个状态参数：</p>
<ul>
<li>down：表示当前 server 暂时不参与负载均衡。</li>
<li>backup：预留的备份机器，当其他所有的非 backup 机器出现故障或者忙的时候，才会请求 backup 机器，因此这台机器的压力最轻。</li>
<li>max_fails：允许请求失败的次数，默认为：1。当超过最大次数时，返回 proxy_next_upstream 模块定义的错误。</li>
<li>fail_timeout：在经历了 max_fails 次失败后，暂停服务的时间。max_fails 可以和 fail_timeout 一起使用。</li>
</ul>
<p>示例如下：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">upstream xdhuxc {
    server 192.168.91.128:8080 weight=2 max_fails=2 fail_timeout=2;
    server 192.168.91.129:8080 weight=1 max_fails=2 fail_timeout=1;
}
</code></pre></td></tr></table>
</div>
</div><h3 id="nginx--location-">nginx 中 location 的写法</h3>
<h4 id="location-">location 基础知识</h4>
<p>1、location 是在 server 块中配置的。</p>
<p>2、可以根据不同的 URI 使用不同的配置（location 中配置），来处理不同的请求。</p>
<p>3、location 是有顺序的，会被第一个匹配的 location 处理。</p>
<h4 id="location--1">location 配置语法</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location [ = | ~ | ~* | ^~ ] uri {...}
或
location <span class="ni">@name</span> {...}
</code></pre></td></tr></table>
</div>
</div><h4 id="location--2">location 配置可以有两种配置方法</h4>
<p>1、前缀 + uri （字符串/正则表达式）</p>
<p>2、@ + name</p>
<h4 id="heading-3">前缀含义</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">=：精确匹配，必须全部相等。
~：大小写敏感。
~*：忽略大小写。
^~：只需匹配 uri 部分。
@：内部服务跳转。
</code></pre></td></tr></table>
</div>
</div><h4 id="location--3">location 配置示例</h4>
<p>（1）=，精确匹配</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location = / {
    # 规则
}
</code></pre></td></tr></table>
</div>
</div><p>匹配到 <a href="http://www.xdhuxc.com/">http://www.xdhuxc.com/</a>  这种请求。</p>
<p>（2）~，大小写敏感</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location ~ /getUser/ {
    # 规则
}
</code></pre></td></tr></table>
</div>
</div><p><a href="http://www.xdhuxc.com/getUser/">http://www.xdhuxc.com/getUser/</a> 请求成功</p>
<p><a href="http://www.xdhuxc.com/GetUser/">http://www.xdhuxc.com/GetUser/</a> 请求失败</p>
<p>（3）~*，大小写忽略</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location ~* /getUser/ {
    # 规则
}
</code></pre></td></tr></table>
</div>
</div><p>这种写法会忽略 uri 部分的大小写</p>
<p><a href="http://www.xdhuxc.com/getUser/">http://www.xdhuxc.com/getUser/</a> 请求成功</p>
<p><a href="http://www.xdhuxc.com/GetUser/">http://www.xdhuxc.com/GetUser/</a> 请求成功</p>
<p>（4）^~，只匹配以 uri 开头</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location ^~ /image/ {
    # 规则
}
</code></pre></td></tr></table>
</div>
</div><p>以 /image/ 开头的请求，都会匹配上</p>
<p><a href="http://xdhuxc.com/image/abc.jpg">http://xdhuxc.com/image/abc.jpg</a> 请求成功</p>
<p><a href="http://xdhuxc.com/image/cde.mp4">http://xdhuxc.com/image/cde.mp4</a> 请求成功</p>
<p>5、@，nginx 内部跳转</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-markdown" data-lang="markdown">location /image/ {
    error_page 404 <span class="ni">@image_error</span>;
}

location <span class="ni">@image_error</span> {
    # 规则
}
</code></pre></td></tr></table>
</div>
</div><p>以 /image/ 开头的请求，如果链接的状态为 404，则会匹配到 @image_error 这条规则上。</p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">xdhuxc</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-10-29
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/nginx/">Nginx</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/programming/python/python-code-example/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Python 常用代码示例</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/message/kafka/message-queue-kafka-install-and-command/">
            <span class="next-text nav-default">Kafka 的部署和常用命令</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:xdhuxc@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/xdhuxc" class="iconfont icon-github" title="github"></a>
  <a href="https://xdhuxc.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">xdhuxc 版权所有</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-139962821-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
