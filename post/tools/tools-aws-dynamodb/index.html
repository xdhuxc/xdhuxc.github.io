<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.55.5" />

  <title>AWS DynamoDB 简单实用 &middot; xdhuxc</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://xdhuxc.github.io/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://xdhuxc.github.io/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="https://xdhuxc.github.io/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

 
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
  
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="https://xdhuxc.github.io/img/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  
  <a class="pure-menu-heading brand" href="https://xdhuxc.github.io/">xdhuxc</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xdhuxc.github.io/"><i class='fa fa-home fa-fw'></i>主页</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xdhuxc.github.io/post/"><i class='fa fa-list fa-fw'></i>博客</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xdhuxc.github.io/about/"><i class='fa fa-user fa-fw'></i>关于</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="https://xdhuxc.github.io/contact/"><i class='fa fa-phone fa-fw'></i>联系作者</a>
      
        </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/xdhuxc" rel="me" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://www.jianshu.com/u/25ff12787f63" rel="me" target="_blank"><i class="fa fa-joomla fa-fw"></i>简书</a>
    </li>
    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/***" rel="me" target="_blank"><i class="fa fa-weixin fa-fw"></i>微信</a>
    </li>
    

  </ul>
</div>


  <div>
  <div class="small-print">
    <small>&copy; 2019. xdhuxc 版权所有。</small>
  </div>
  <div class="small-print">

  </div>
  <div class="small-print">
    <small id="busuanzi_container_site_pv" style='display:none'> 访问量 <span id="busuanzi_value_site_pv"></span> 次</small>
    <br>
    <small id="busuanzi_container_site_uv" style='display:none'> 访客数 <span id="busuanzi_value_site_uv"></span> 人次 </small>
    <br>
    <small>构建&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <br>
    <small>主题&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>

<div id="main">


<div class="header">
  <h1>AWS DynamoDB 简单实用</h1>
  <h2></h2>
  <div>
    <font style="font-family: 'STKaiti';">
      <span>创建于 2019-06-02</span> |
      <span>修改于 2019-06-02</span> |
      <span>总字数 1216</span> |
      <span>阅读时长 3 分钟</span> |
      <span id="busuanzi_container_page_pv"> 阅读量 <span id="busuanzi_value_page_pv"></span> 次</span>
    </font>
  </div>
</div>
<div class="content">

  <div class="post-meta">

  <div>
    <i class="fa fa-calendar fa-fw"></i>
    <time>2019-06-02</time>
  </div>

  

  

  
  
  
  <div>
    <i class="fa fa-tags fa-fw"></i>
    
      <a class="post-taxonomy-tag" href="https://xdhuxc.github.io/tags/aws">AWS</a>&nbsp;&#47;
    
      <a class="post-taxonomy-tag" href="https://xdhuxc.github.io/tags/dynamodb">DynamoDB</a>
    
  </div>
  
  

</div>


  <p>本篇博客记录下使用 AWS DynamoDB 过程中用到的一些知识和技术点，以备后需。</p>

<p>Amazon DynamoDB 是一个键/值和文档数据库，可以在任何规模的环境中提供个位数的毫秒级性能。它是一个完全托管的多区域多主数据库，具有适用于 Internet 规模的应用程序的内置安全性、备份和恢复和内存缓存。DynamoDB 每天可处理超过 10 万亿个请求，并可支持每秒超过 2000 万个请求的峰值。</p>

<h3 id="使用-docker-本地部署-dynamodb">使用 docker 本地部署 DynamoDB</h3>

<p>使用 docker 容器本地部署 DynamoDB 实例</p>

<pre><code class="language-markdown">docker run -d -p 8000:8000 amazon/dynamodb-local
</code></pre>

<h3 id="使用命令行操作-dynamodb">使用命令行操作 DynamoDB</h3>

<p>在本地启动 DynamoDB 数据库实例，配置如下环境变量</p>

<pre><code class="language-angular2html">export AWS_REGION=ap-southeast-1
export DYNAMODB_LOCAL=http://localhost:8000
</code></pre>

<p>执行 aws 命令前，需要在 ~/.aws/credentials 中配置访问 DynamoDB 的 Access Key 和 Secret Key，如下所示：</p>

<pre><code class="language-markdown">[default]
aws_access_key_id = ${aws_access_key_id}
aws_secret_access_key = ${aws_access_key_id}
</code></pre>

<p>在 ~/.aws/config 中配置区域，如下所示：</p>

<pre><code class="language-markdown">[default]
region = ap-southeast-1
</code></pre>

<p>如果是本地启动的 DynamoDB 实例，只需任意一个合法的 DynamoDB Access Key 和 Secret Key 即可。</p>

<p>1、显示所有数据库表</p>

<pre><code class="language-angular2html">aws dynamodb list-tables --endpoint-url http://localhost:8000
</code></pre>

<p>2、显示特定表信息</p>

<pre><code class="language-angular2html">aws dynamodb describe-table --table-name xdhuxc --endpoint-url http://localhost:8000
</code></pre>

<p>3、创建表</p>

<pre><code class="language-angular2html">aws dynamodb create-table \
    --table-name xdhuxc \
    --attribute-definitions \
        AttributeName=key,AttributeType=S \
    --key-schema \
        AttributeName=key,KeyType=HASH \
    --provisioned-throughput ReadCapacityUnits=10,WriteCapacityUnits=10 \
    --endpoint-url http://localhost:8000
</code></pre>

<p>4、插入 JSON 格式数据</p>

<pre><code class="language-markdown">aws dynamodb put-item --table-name xdhuxc \
    --item '{ &quot;key&quot;: { &quot;S&quot;: &quot;/myapp/study/hosts/codelieche&quot; }, &quot;value&quot;: {&quot;S&quot;: &quot;{\&quot;domain\&quot;: \&quot;www.codelieche.com\&quot;, \&quot;ip\&quot;: \&quot;192.168.1.101\&quot;}&quot; }}' \
    --endpoint-url http://localhost:8000
    
aws dynamodb put-item --table-name xdhuxc \
    --item '{ &quot;key&quot;: { &quot;S&quot;: &quot;/myapp/study/hosts/codelieche2&quot; }, &quot;value&quot;: {&quot;S&quot;: &quot;{\&quot;domain\&quot;: \&quot;www.codelieche.com\&quot;, \&quot;ip\&quot;: \&quot;192.168.1.101\&quot;}&quot;}}' \
    --endpoint-url http://localhost:8000
</code></pre>

<p>5、查看 dynamodb 数据库中所有数据</p>

<pre><code class="language-angular2html">aws dynamodb scan --table-name xdhuxc --endpoint-url http://localhost:8000
</code></pre>

<h3 id="使用-golang-操作-dynamodb">使用 golang 操作 DynamoDB</h3>

<p>可以使用 AWS 提供的 golang SDK 来操作 DynamoDB，实现在我们的程序内部对 DynamoDB 的调用。</p>

<p>注意，执行批量操作时，有数据量限制，每次只能增删 25 条数据，多余的将会报错（BatchLimit = 25）。</p>

<p>1、创建 dynamodb 客户端，对 DynamoDB 的操作都要使用该客户端来进行。</p>

<pre><code class="language-markdown">func NewDynamoDBClient(region string, endpoint string, disableSSL bool) (*dynamodb.DynamoDB, error) {
	if region == &quot;&quot; {
		sess, err := session.NewSession()
		if err != nil {
			return nil, err
		}
		metadata := ec2metadata.New(sess)
		ec2Region, err := metadata.Region()
		if err != nil {
			return nil, fmt.Errorf(&quot;aws DynamoDB requires a region&quot;)
		}
		region = ec2Region
	}
	var c *aws.Config
	// 使用环境变量中的 AccessKey 和 SecretKey
	accessKey := os.Getenv(&quot;AWS_ACCESS_KEY_ID&quot;)
	secretKey := os.Getenv(&quot;AWS_SECRET_ACCESS_KEY&quot;)
	if accessKey != &quot;&quot; &amp;&amp; secretKey != &quot;&quot; {
		creds := credentials.NewStaticCredentials(accessKey, secretKey, &quot;&quot;)
		c = &amp;aws.Config{
			Region:      aws.String(region),
			Credentials: creds,
			Endpoint:    aws.String(endpoint),
			DisableSSL:  aws.Bool(disableSSL),
		}
	} else if accessKey != &quot;&quot; &amp;&amp; secretKey != &quot;&quot; { // 使用配置文件中的 AccessKey 和 SecretKey
		creds := credentials.NewStaticCredentials(accessKey, secretKey, &quot;&quot;)
		c = &amp;aws.Config{
			Region:      aws.String(region),
			Credentials: creds,
			Endpoint:    aws.String(endpoint),
			DisableSSL:  aws.Bool(disableSSL),
		}
	} else {
		c = &amp;aws.Config{ // 使用 ~/.aws/credentials 文件中的 AccessKey 和 SecretKey 。
			Region:     aws.String(region),
			Endpoint:   aws.String(endpoint),
			DisableSSL: aws.Bool(disableSSL),
		}
	}

	sess, err := session.NewSession(c)
	if err != nil {
		return nil, err
	}

	db := dynamodb.New(sess)

	return db, nil
}
</code></pre>

<p>2、创建表</p>

<pre><code class="language-markdown">func CreateTable(ddb *dynamodb.DynamoDB, tableName string) error {
	itemInput := &amp;dynamodb.CreateTableInput{
		AttributeDefinitions: []*dynamodb.AttributeDefinition{
			{
				AttributeName: aws.String(&quot;key&quot;),
				AttributeType: aws.String(&quot;S&quot;),
			},
		},
		KeySchema: []*dynamodb.KeySchemaElement{
			{
				AttributeName: aws.String(&quot;key&quot;),
				KeyType:       aws.String(&quot;HASH&quot;),
			},
		},
		ProvisionedThroughput: &amp;dynamodb.ProvisionedThroughput{
			ReadCapacityUnits:  aws.Int64(10),
			WriteCapacityUnits: aws.Int64(10),
		},
		TableName: aws.String(tableName),
	}
	_, err := ddb.CreateTable(itemInput)
	if err != nil {
		return err
	}

	return nil
}
</code></pre>

<p>3、向 dynamodb 表中插入键值对</p>

<pre><code class="language-markdown">func insert2DynamoDB(ddb *dynamodb.DynamoDB, tableName string, key string, value string) error {
 	itemInput := &amp;dynamodb.PutItemInput{
 		TableName: aws.String(tableName),
 		Item: map[string]*dynamodb.AttributeValue{
 			&quot;key&quot;: {                 // 注意，建表时键名起为 key。
 				S: aws.String(key),
 			},
 			&quot;value&quot;: {
 				S: aws.String(value),
         			},
 		},
 	}

 	if _, err := ddb.PutItem(itemInput); err != nil {
 		return err
 	}
 	return nil
 }
</code></pre>

<p>4、向 dynamodb 表中批量插入键值数据</p>

<pre><code class="language-markdown">func batchWrite2DynamoDB(ddb *dynamodb.DynamoDB, tableName string, data map[string]string) error {
	requestItems := make(map[string][]*dynamodb.WriteRequest)
	length := len(data)
	var writeRequests []*dynamodb.WriteRequest
	count := 0
	writeRequests = []*dynamodb.WriteRequest{}
	for key, value := range data {// 键值数据
		var writeRequest *dynamodb.WriteRequest
		writeRequest = &amp;dynamodb.WriteRequest{
			PutRequest: &amp;dynamodb.PutRequest{
				Item: map[string]*dynamodb.AttributeValue{
					&quot;key&quot;: {
						S: aws.String(key),
					},
					&quot;value&quot;: {
						S: aws.String(value),
					},
				},
			},
		}
		writeRequests = append(writeRequests, writeRequest)
		count = count + 1

		if (count % utils.BatchLimit == 0) || (count &gt;= length) {
			requestItems[tableName] = writeRequests
			batchInput := &amp;dynamodb.BatchWriteItemInput{
				RequestItems: requestItems,
			}

			if _, err := ddb.BatchWriteItem(batchInput); err != nil {
				return err
			}
			writeRequests = []*dynamodb.WriteRequest{}
		}
	}

	return nil
}
</code></pre>

<p>5、批量删除数据
此处是通过批量删除的方式删除了全部数据，但是保留了表结构，之所以没有采用删除表的操作，是因为线上环境，权限所限</p>

<pre><code class="language-markdown">func BatchDeleteItems(ddb *dynamodb.DynamoDB, tableName string) error {
	errc := make(chan error, 1)
	wg := sync.WaitGroup{}

	scannedData, err := ddb.Scan(&amp;dynamodb.ScanInput{TableName: aws.String(tableName)})
	if err != nil {
		return err
	}

	length := len(scannedData.Items)
	wg.Add(int(math.Ceil((float64(length)) / float64(utils.BatchLimit))))

	req := []*dynamodb.WriteRequest{}
	for i, a := range scannedData.Items {
		req = append(req, &amp;dynamodb.WriteRequest{
			DeleteRequest: &amp;dynamodb.DeleteRequest{
				Key: map[string]*dynamodb.AttributeValue{
					&quot;key&quot;: a[&quot;key&quot;],
				},
			},
		})
		if (i+1) % utils.BatchLimit == 0 || i &gt;= int(*scannedData.Count)-1 {
			go func(reqChunk []*dynamodb.WriteRequest) {
				defer wg.Done()
				_, err := t.DdbClient.BatchWriteItem(&amp;dynamodb.BatchWriteItemInput{
					RequestItems: map[string][]*dynamodb.WriteRequest{
						t.TableName: reqChunk,
					},
				})
				if err != nil {
					errc &lt;- err
				}
			}(req)
			req = []*dynamodb.WriteRequest{}
		}
	}
	go func() {
		wg.Wait()
		close(errc)
	}()
	return &lt;-errc
}
</code></pre>

<p>6、删除数据表</p>

<pre><code class="language-markdown">func DeleteTable(ddb *dynamodb.DynamoDB, tableName string) error {
	itemInput := &amp;dynamodb.DeleteTableInput{
		TableName: aws.String(tableName),
	}

	if _, err := ddb.DeleteTable(itemInput); err != nil {
		return err
	}
	return nil
}
</code></pre>

<h3 id="参考资料">参考资料</h3>

<p>docker 方式部署 DynamoDB</p>

<p><a href="https://hub.docker.com/r/amazon/dynamodb-local">https://hub.docker.com/r/amazon/dynamodb-local</a></p>

<p>原生方式部署 DynamoDB</p>

<p><a href="https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html">https://docs.aws.amazon.com/zh_cn/amazondynamodb/latest/developerguide/DynamoDBLocal.DownloadingAndRunning.html</a></p>

<p>DynamoDB Golang SDK</p>

<p><a href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/">https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/</a></p>

  
  
<span id="/post/tools/tools-aws-dynamodb/" class="leancloud_visitors" data-flag-title="AWS DynamoDB 简单实用">
    <span class="post-meta-item-text">文章阅读量 </span>
    <span class="leancloud-visitors-count"></span>
    <p></p>
</span>
<div id="vcomments"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<script type="text/javascript">
    new Valine({
        el: '#vcomments' ,
        appId: 'YsFphzyKIQLER09mV5x6wcHp-gzGzoHsz',
        appKey: '0u59ooH7ebMlKP9lcvWwwEh7',
        notify: 'false',
        verify: 'false',
        avatar:'identicon',
        placeholder: '说点什么吧...',
        visitor: 'true'
    });
</script>



  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="https://xdhuxc.github.io/post/golang/go-test/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="https://xdhuxc.github.io/post/golang/go-test/">Golang 单元测试</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="https://xdhuxc.github.io/post/tools/tools-confd/">配置拉取工具 confd 的使用及说明</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="https://xdhuxc.github.io/post/tools/tools-confd/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



</div>

</div>
</div>
<script src="https://xdhuxc.github.io/js/ui.js"></script>
<script src="https://xdhuxc.github.io/js/menus.js"></script>


    <script>
    var _hmt = _hmt || [];
    (function() {
        if (window.location.hostname === "localhost") {
            return;
        }
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ad57771d1b8d25cbd18d12f67bc32135";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


    
<script>
  
  if (window.location.hostname != "localhost") {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-139962821-1', 'auto');
    ga('send', 'pageview');
  }
</script>


    

<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="\/\/analytics.example.com\/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId',  2 ]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//analytics.example.com/piwik.php?idsite=2" style="border:0;" alt="" /></p></noscript>




</body>
</html>

